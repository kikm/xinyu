<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <title>新域公司</title>
    <link rel="stylesheet" href="style/weui/weui.css"/>
    <link rel="stylesheet" href="style/weui/example.css"/>
    <link rel="stylesheet" href="style/weui/jquery-weui.min.css"/>
</head>
<body ontouchstart>
  <input type="hidden" id="hidopenId" name="openId" th:value="${openId}">
  <input type="hidden" id="hidorderId" name="orderId" value="">
  <div class="weui-toptips weui-toptips_success js_tooltips" style="display: none; opacity: 1;">错误提示</div>
  <div class="container js_container" id="container">
  </div>
    
<script type="text/html" id="tpl_home">
<div class="page">
  <div class="weui-form">
    <div class="weui-form__text-area">
      <h1 class="weui-form__title">
		<img src="images/xinyulogo.jpg" alt="XinYu" height="21px" />&nbsp;新域
	  </h1>
      <div class="weui-form__desc">绑定账号后可进入查看新域公司业务详情</div>
    </div>
    <div class="weui-form__control-area">
      <div class="weui-cells__group weui-cells__group_form">
        <div class="weui-cells__title"></div>
        <div class="weui-cells weui-cells_form">
          <div class="weui-cell" id="js_cell">
            <div class="weui-cell__hd"><label class="weui-label">账号</label></div>
            <div class="weui-cell__bd">
                <input id="js_input" class="weui-input" autofocus type="text" pattern="[0-9]*" placeholder="请输入账号"  maxlength="16" />
                <button id="js_input_clear" class="weui-btn_reset weui-btn_icon weui-btn_input-clear">
                  <i class="weui-icon-clear"></i>
                </button>
            </div>
          </div>
		  <div class="weui-cell" id="js_cell">
            <div class="weui-cell__hd"><label class="weui-label">密码</label></div>
            <div class="weui-cell__bd">
                <input id="js_input2" class="weui-input" placeholder="请输入密码" autofocus type="password" />
                <button id="js_input_clear2" class="weui-btn_reset weui-btn_icon weui-btn_input-clear">
                  <i class="weui-icon-clear"></i>
                </button>
            </div>
          </div>
		  <div class="weui-cell">
            <div class="weui-cell__hd"><label class="weui-label"></label></div>
          </div>
        </div>
      </div>
    </div>
    <div class="weui-form__opr-area">
      <a class="weui-btn weui-btn_primary weui-btn_disabled" href="javascript:" id="showTooltips">确定</a>
    </div>
  </div>
  <div id="js_toast" style="display: none;">
      <div class="weui-mask_transparent"></div>
      <div class="weui-toast">
          <i class="weui-icon-success-no-circle weui-icon_toast"></i>
          <p class="weui-toast__content">已完成</p>
      </div>
  </div>
  <!-- loading toast -->
  <div id="loadingToast" style="display:none;">
        <div class="weui-mask_transparent"></div>
        <div class="weui-toast">
            <i class="weui-loading weui-icon_toast"></i>
            <p class="weui-toast__content">核验中</p>
        </div>
  </div>
  <div id="dialogs">
	<!--BEGIN dialog2-->
     <div class="js_dialog" id="iosDialog2" style="display: none;">
     	<div class="weui-mask"></div>
            <div class="weui-dialog">
                <div class="weui-dialog__bd">绑定成功</div>
                <div class="weui-dialog__ft">
                    <a href="javascript:;" class="weui-dialog__btn weui-dialog__btn_primary">确定</a>
                </div>
            </div>
        </div>
     <!--END dialog2-->
   </div>
</div>

<script type="text/javascript">
    $(function(){
		var openId = $('#hidopenId').val();
		var $tooltips = $('.js_tooltips');
      	var $toast = $('#js_toast');
		var $loadtoast = $('#loadingToast');
      	var $input = $('#js_input');
	  	var $input2 = $('#js_input2');
      	var $inputClear = $('#js_input_clear');
	  	var $inputClear2 = $('#js_input_clear2');
      	var $cell = $('#js_cell');
	  	var $iosDialog2 = $('#iosDialog2');

		$input.on('input', function(){
        	var $value = $input.val();
        	if ($cell.hasClass('weui-cell_warn')){
          		$cell.removeClass('weui-cell_warn');
        	}
        	if ($value){
          		$('#showTooltips').removeClass('weui-btn_disabled');
        	}else{
          		$('#showTooltips').addClass('weui-btn_disabled');
       		}
      	});
		$('#dialogs').on('click', '.weui-dialog__btn', function(){
            $(this).parents('.js_dialog').fadeOut(200);
        });
		$('#showTooltips').on('click', function(){
        	if ($(this).hasClass('weui-btn_disabled')) return;

          	var $value = $input.val();
			var $value2 = $input2.val();
          	if ($tooltips.css('display') != 'none') return;

          	// toptips的fixed, 如果有`animation`, `position: fixed`不生效
          	$('.page.cell').removeClass('slideIn');

          	if($value.length == ''){
            	$cell.addClass('weui-cell_warn');
            	$tooltips.fadeIn(100);
            	setTimeout(function () {
              		$tooltips.fadeOut(100);
            	}, 2000);
          	}else{
				$loadtoast.fadeIn(200);
				$.ajax({
    				url:"login",    //请求的url地址
    				async:true,//请求是否异步，默认为异步，这也是ajax重要特性
    				data:{"username":$value+'-'+openId,"password":$value2},    //参数值
    				type:"POST",   //请求方式
    				success:function(req){
              			$loadtoast.fadeOut(100);
        				$iosDialog2.fadeIn(200);
						window.pageManager.go('preview');
    				},
				});
          	}

		});

      	$inputClear.on('click', function(){
        	$input.val('');
      	});
	  	$inputClear2.on('click', function(){
        	$input2.val('');
      	});

	});
</script>
</script>
<script type="text/html" id="tpl_preview">
<div class="page">
    <div class="page__bd" style="height: 100%;">
        <div class="weui-tab">
            <div class="weui-tab__bd">
        		<div id="tab1" class="infinite" style="overflow:auto;height: 100%">
					<div class="content-padded Dispatched">
        				
      				</div>
      				<div class="weui-loadmore">
  						<i class="weui-loading"></i>
  						<span class="weui-loadmore__tips">正在加载</span>
					</div>
        		</div>
        		<div id="tab2" class="infinite" style="display: none;overflow:auto;height: 100%">
            		<div class="content-padded OrderConfirmed">
      					
    				</div>
					<div class="weui-loadmore">
  							<i class="weui-loading"></i>
  							<span class="weui-loadmore__tips">正在加载</span>
					</div>
        		</div>
    		</div>
            <div class="weui-tabbar">
                <a href="#tab1" class="weui-tabbar__item weui-bar__item_on" page="2" status="Dispatched">
                    <span style="display: inline-block;position: relative;">
                        <img src="images/weimages/icon_tabbar.png" alt="" class="weui-tabbar__icon">
                        <!--<span class="weui-badge" style="position: absolute;top: -2px;right: -13px;">8</span>-->
                    </span>
                    <p class="weui-tabbar__label">待检修</p>
                </a>
                <a href="#tab2" class="weui-tabbar__item" page="2" status="OrderConfirmed">
                    <img src="images/weimages/icon_tabbar.png" alt="" class="weui-tabbar__icon">
                    <p class="weui-tabbar__label">待完修</p>
                </a>
            </div>
        </div>
    </div>
</div>
<div id="previewTemplate" style="display:none">
<br>
<div class="weui-form-preview">
	<div class="weui-form-preview__hd">
        	<div class="weui-form-preview__item">
            	<label class="weui-form-preview__label">工单编号</label>
            	<em class="weui-form-preview__value"></em>
            </div>
    </div>
    <div class="weui-form-preview__bd">
        <div class="weui-form-preview__item">
             <label class="weui-form-preview__label">申请人</label>
             <span class="weui-form-preview__value"></span>
        </div>
        <div class="weui-form-preview__item">
             <label class="weui-form-preview__label">联系电话</label>
             <span class="weui-form-preview__value"></span>
        </div>
        <div class="weui-form-preview__item">
             <label class="weui-form-preview__label">设备类型</label>
             <span class="weui-form-preview__value"></span>
        </div>
        </div>
			<div class="weui-form-preview__ft">
                <a class="weui-form-preview__btn weui-form-preview__btn_default feedbackOrComplete" data-id="1" href="javascript:">确认</a>
            	<button type="submit" class="weui-form-preview__btn weui-form-preview__btn_primary detail" data-id="1" href="javascript:">详情</button>
			</div>
        </div>
</div>
<script type="text/javascript">
    $(function(){
		var page = 1
		var loading = false;  //状态标记
		var status = $('.weui-bar__item_on').attr('status');
		var tempValue = $('#previewTemplate').find(".weui-form-preview__value");
		var $tooltips = $('.js_tooltips');
        var openId = $('#hidopenId').val();
		$.ajax({
    		url:"wx/getMobileData",    //请求的url地址
    		async:false,//请求是否异步，默认为异步，这也是ajax重要特性
    		data:{"status":status,"limit":2,"page":page,"openId":openId,'type':'technician'},    //参数值
    		type:"POST",   //请求方式
    		success:function(data){
				var t1 = 0;
				var t2 = 0;
				for(let i=0;i<data.length;i++){
				 	var bean = data[i];
					if(bean.status == 'Dispatched'){t1+=1}
					if(bean.status == 'OrderConfirmed'){t2+=1}
				}
				var status = [];
				if(t1<2){status.push('Dispatched');}
				if(t2<2){status.push('OrderConfirmed');}
				for(let i = 0;i<status.length ; i++){
					$('.'+status[i]).parent().find('.weui-loadmore').children('.weui-loading').hide();
					$('.'+status[i]).parent().find('.weui-loadmore').children('.weui-loadmore__tips').html("没有更多数据");
					$('.weui-bar__item_on').attr('noMoreData','true');
				}
				addTempleHtml(data);
    		}
		});	

		function addTempleHtml(data){
			for(let i=0;i<data.length;i++){
					var bean = data[i];
					$(tempValue).eq(0).html(bean.orderNo);
					$(tempValue).eq(1).html(bean.contact);
					$(tempValue).eq(2).html(bean.phone);
					$(tempValue).eq(3).html(bean.deviceName);
					$('#previewTemplate').find(".feedbackOrComplete").eq(0).attr('data-id',bean.id);
					if(bean.status == 'Dispatched'){
						$(".Dispatched").append($('#previewTemplate').html());
					}
					if(bean.status == 'OrderConfirmed'){
						$(".OrderConfirmed").append($('#previewTemplate').html());
						
					}
				}
		}

		
		//下拉更新数据
		$('.infinite').infinite().on("infinite", function() {
			var self = this;
			$('.weui-loadmore').removeClass("display:none");
            self.loading = true;
			var status = $('.weui-bar__item_on').attr('status');
			var page = $('.weui-bar__item_on').attr('page');
			var getData = $('.weui-bar__item_on').attr('noMoreData');
			var appHtml = $('#previewTemplate').html();
			$.ajax({
    				url:"wx/getMobileData",    //请求的url地址
    				async:false,
    				data:{"status":status,"limit":2,"page":page,'openId':openId,'type':'technician'},    //参数值
    				type:"POST",   //请求方式
    				success:function(data){
						if(data.length<1){
							$('.'+status).parent().find('.weui-loadmore').children('.weui-loading').hide();
							$('.'+status).parent().find('.weui-loadmore').children('.weui-loadmore__tips').html("没有更多数据");
							$('.weui-bar__item_on').attr('noMoreData','true');
						}else{
							addTempleHtml(data);
							$('.weui-loadmore').addClass("display:none");
    						self.loading = false;
							$('.weui-bar__item_on').attr('page',page+1);
						}
    				}
					
			});	
					
			
		});
	
		$('.weui-tabbar__item').on('click', function () {
      		$(this).addClass('weui-bar__item_on').siblings().removeClass('weui-bar__item_on');
      		var tabId = $(this).attr('href');
     		$('.weui-tab__bd').find(tabId).show().siblings().hide();
			$('.weui-tab__bd').find(tabId).infinite();
    	});
	
		$('.weui-form-preview__btn.weui-form-preview__btn_primary.detail').on('click', function(){
            var order = $(this).data('id');
			window.pageManager.go('article');
        });
		
		$('.weui-form-preview__btn.weui-form-preview__btn_default.feedbackOrComplete').on('click', function(){
            var orderId = $(this).data('id');
			var $clickConfirm = $(this);
			var status = $('.weui-bar__item_on').attr('status');
			if(orderId == null||orderId=='')return;
			if(status=='Dispatched'){
				$('#hidorderId').val(orderId);
				window.pageManager.go('article');
			}else {
				$.ajax({
    				url:"wx/complete",    //请求的url地址
    				async:false,
    				data:{"orderId":orderId,"openId":openId},    //参数值
    				type:"POST",   //请求方式
    				success:function(data){
						$tooltips.text(data.msg);
						if(data.code == 0){
							$($clickConfirm).data('id','');
							$tooltips.removeClass('weui-toptips_warn');
							$tooltips.addClass('weui-toptips_success');
						}else{
							$tooltips.removeClass('weui-toptips_success');
							$tooltips.addClass('weui-toptips_warn');
						}
						$tooltips.css('display','block');
						setTimeout(function () {
  							$tooltips.css('display','none');
 						}, 2000);
    				}
				});	
			}
        });

		
    });
	
	
</script>
</script>

<script type="text/html" id="tpl_article">
<div class="page">
  <div class="weui-form">
    <div class="weui-form__text-area">
      <h1 class="weui-form__title">
		工单维修反馈
	  </h1>
    </div>
	<form id='feedbackForm' enctype='multipart/form-data' method='POST'>
    <div class="weui-form__control-area">
      <div class="weui-cells__group weui-cells__group_form">
        <div class="weui-cells__title">文本域</div>
        <div class="weui-cells weui-cells_form">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <textarea class="weui-textarea" placeholder="请输入文本" rows="3"></textarea>
                    <div class="weui-textarea-counter"><span>0</span>/200</div>
                </div>
            </div>
        </div>
		  <div class="weui-cells weui-cells_form" id="uploader">
     <div class="weui-cell">
         <div class="weui-cell__bd">
             <div class="weui-uploader">
                 <div class="weui-uploader__hd">
                     <p class="weui-uploader__title">图片上传</p>
                     <div class="weui-uploader__info"><span id="uploadCount">0</span>/5</div>
                 </div>
                 <div class="weui-uploader__bd">
                     <ul class="weui-uploader__files" id="uploaderFiles"></ul>
                     <div class="weui-uploader__input-box">
                         <input id="uploaderInput" class="weui-uploader__input" type="file" accept="image/*" capture="camera" multiple="" />
                     </div>
                 </div>
             </div>
         </div>
     </div>
 </div>
</form>
<div id="gallery" class="weui-gallery">
    <span class="weui-gallery__img" style="background-image: url(xxx);"></span>
    <div class="weui-gallery__opr">
        <a href="javascript:" class="weui-gallery__del">
            <i class="weui-icon-delete weui-icon_gallery-delete"></i>
        </a>
    </div>
		  <div class="weui-cell">
            <div class="weui-cell__hd"><label class="weui-label"></label></div>
          </div>
        </div>
      </div>
    </div>
    <div class="weui-form__opr-area">
      <a class="weui-btn weui-btn_primary weui-btn_disabled" href="javascript:" id="feedbackButton">确定</a>
    </div>
  </div>
</div>
<!-- loading toast -->
 <div id="loadingToast" style="display:none;">
     <div class="weui-mask_transparent"></div>
     <div class="weui-toast">
         <i class="weui-loading weui-icon_toast"></i>
         <p class="weui-toast__content">数据加载中</p>
     </div>
 </div>  
</div>

<script type="text/javascript">
    $(function(){
		var formData = new FormData($( "#feedbackForm" )[0]); 
		formData.append('technicianOpenId',$('#hidopenId').val());
		formData.append('orderId',$('#hidorderId').val());
		var $textarea = $('.weui-textarea');
		var $tooltips = $('.js_tooltips');
		var $loadingToast = $('#loadingToast');
		var uploadCount = 0;
		weui.uploader('#uploader', {
   			url: 'http://localhost:8080',
   			auto: false,
   			type: 'file',
   			fileVal: 'fileVal',
   			compress: {
       			width: 1600,
       			height: 1600,
       			quality: .8
   			},
   			onBeforeQueued: function(files) {
       			// `this` 是轮询到的文件, `files` 是所有文件
       			if(["image/jpg", "image/jpeg", "image/png", "image/gif"].indexOf(this.type) < 0){
           			weui.alert('请上传图片');
           			return false; // 阻止文件添加
       			}
       			if(this.size > 10 * 1024 * 1024){
           			weui.alert('请上传不超过10M的图片');
           			return false;
       			}
       			if (files.length > 5) { // 防止一下子选择过多文件
           			weui.alert('最多只能上传5张图片，请重新选择');
           			return false;
       			}
       			if (uploadCount + 1 > 5) {
           			weui.alert('最多只能上传5张图片');
           			return false;
       			}
				formData.append("file",this);
       			++uploadCount;
				$('#uploadCount').text(uploadCount);
       			// return true; // 阻止默认行为，不插入预览图的框架
   			},
   			onQueued: function(){
       			console.log(this);
				
       			// console.log(this.status); // 文件的状态：'ready', 'progress', 'success', 'fail'
       			// console.log(this.base64); // 如果是base64上传，file.base64可以获得文件的base64

       			// this.upload(); // 如果是手动上传，这里可以通过调用upload来实现；也可以用它来实现重传。
       			// this.stop(); // 中断上传

       			// return true; // 阻止默认行为，不显示预览图的图像
   			},
   			onBeforeSend: function(data, headers){
       			console.log(this, data, headers);
       			// $.extend(data, { test: 1 }); // 可以扩展此对象来控制上传参数
       			// $.extend(headers, { Origin: 'http://127.0.0.1' }); // 可以扩展此对象来控制上传头部

       			// return false; // 阻止文件上传
   			},
   			onProgress: function(procent){
       			console.log(this, procent);
       			// return true; // 阻止默认行为，不使用默认的进度显示
   			},
   			onSuccess: function (ret) {
       			console.log(this, ret);
       			// return true; // 阻止默认行为，不使用默认的成功态
   			},
   			onError: function(err){
       			console.log(this, err);
       			// return true; // 阻止默认行为，不使用默认的失败态
   			}
		});

		$textarea.on('input', function(){
        	var $value = $textarea.val();
			$('.weui-textarea-counter').children("span").eq(0).text($value.length);
        	if ($value){
          		$('#feedbackButton').removeClass('weui-btn_disabled');
        	}else{
          		$('#feedbackButton').addClass('weui-btn_disabled');
       		}
      	});

		$('#feedbackButton').on('click', function(){
        	if ($(this).hasClass('weui-btn_disabled')) return;
			$(this).addClass('weui-btn_disabled');
			if ($loadingToast.css('display') != 'none') return;
          	var $value = $textarea.val();

            $loadingToast.fadeIn(100);
                
          	if($value.length == ''){
            	$cell.addClass('weui-cell_warn');
            	$tooltips.fadeIn(100);
            	setTimeout(function () {
              		$tooltips.fadeOut(100);
            	}, 2000);
          	}else{
				formData.append('report',$value);
				$.ajax({
    				url:"wx/maintenanceFeedback",    //请求的url地址
    				async:false,
    				type:"POST",   //请求方式
    				data:formData,    //参数值
					contentType: false,   //jax 中 contentType 设置为 false 是为了避免 JQuery 对其操作，从而失去分界符，而使服务器不能正常解析文件
                	processData: false,
    				success:function(req){
						$tooltips.text(req.msg);
						if(req.code == 0){
							window.pageManager.go('preview');
							$('#hidorderId').val('');
						}else{
							$.toptip(req.msg, 'warn');
							$('#feedbackButton').removeClass('weui-btn_disabled');
						}
						$tooltips.css('display','block');
						setTimeout(function () {
  							$tooltips.css('display','none');
 						}, 2000);
    				},
				});
          	}

		});


	});
</script>
</script>
    
    <script src="scripts/weui/zepto.min.js"></script>
    <script src="scripts/weui/jquery-weui.min.js"></script>
    <script src="scripts/weui/weui.min.js"></script>
    <script src="scripts/weui/example.js"></script>
</body>
</html>